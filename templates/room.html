{% extends "components/base.html" %}
{% load staticfiles compress video_utils %}

{% block metadata %}
  <title>{% block title %}Audiências Interativas{% endblock title%}</title>
  <meta name="description" content="{{ object.reunion_object }}">
  <meta property="og:title" content="{{object.legislative_body_alias}}">
  <meta property="og:site_name" content="Audiências Interativas">
  <meta property="og:description" content="{{ object.reunion_object }}">
  <meta property="og:image" content="{{request.scheme}}://{{domain}}{% static 'img/facebook-share-image.jpg' %}">
  <meta property="og:image:type" content="image/jpg">
  <meta property="og:image:width" content="600">
  <meta property="og:image:height" content="300">
  <meta property="og:type" content="website">
  <meta property="og:type" content="website">
  <meta property="twitter:image" content="{{request.scheme}}://{{domain}}{% static 'img/facebook-share-image.jpg' %}">


{% endblock metadata %}

{% block navigation %}
{% endblock navigation %}

{% block main %}
  <nav class="room-tabs">
    <div class="list">
      <a data-tab-index="0">Vídeo</a>
      <a data-tab-index="1">Bate-Papo</a>
      <a data-tab-index="2">Perguntas</a>
      <div class="marker" data-tab-index="0"></div>
    </div>
  </nav>

  <header class="room-header JS-room-wrapper" data-room-id="{{object.id}}">

    <a class="logo" href="{% url 'home' %}">
      <img src="{% static 'img/logo-audiencias-h.svg' %}">
    </a>

    <div class="room-title">
      <h1 class="title">
        {% if object.reunion_theme %}
          {{object.reunion_theme}}
        {% else %}
          {% if object.is_joint %}
            {{object.title_reunion}}
          {% else %}
            {{object.legislative_body_alias}}
          {% endif %}
        {% endif %}
      </h1>
      <div class="info">
        <span class="social-share">
          <a class="button -facebook JS-share-lnk" data-social="facebook" title="Facebook"></a>
          <a class="button -twitter JS-share-lnk" data-social="twitter" title="Twitter"></a>
          <a class="button -whatsapp JS-share-lnk" data-social="whatsapp" title="Whatsapp"></a>
        </span>
        <span><a class="link" href="{{request.path}}/relatorio">Ver relatório</a></span>
        <span>{{object.reunion_type}}</span>
        <span>{{object.date}}</span>
      </div>
    </div>
  </header>

  <div class="room-container">

    <aside class="room-questions">
      <h2 class="room-h2">Perguntas</h2>
      <p class="-small">Faça sua pergunta ou apoie outra já feita. As perguntas mais votadas serão encaminhadas à Mesa para serem respondidas.</p>
      <div class="questions-section JS-wrapperQuestion">
      <a class="link" href="{{request.path}}/perguntas">Ir para a página de perguntas</a>
      <div class="questions JS-wrapperQuestion">
        <ul class="questions__list JS-questionsList" id="questions">
          {% if questions %}
            {% for question in questions %}
              {% include "includes/question_card.html" with page="room" %}
            {% endfor %}
          {% elif object.youtube_status != 2 %}
            <div class="questions__list--empty JS-questionlistEmpty">
              <img src="{% static 'img/question-hand.svg' %}" data-fallback="{% static 'img/question-hand.png' %}">
              <p>Nenhuma pergunta foi feita ainda. Seja o primeiro!</p>
            </div>
          {% endif %}
        </ul>
      </div>
      <button class="question-button JS-openQuestionForm">Enviar Pegunta</button>
      {% if object.youtube_status != 2 and user.is_authenticated %}
        <form class="question-box JS-formQuestion" id="questionform">
          <div class="header">
            <label class="label">Enviar pergunta:</label>
            <div class="counter JS-character-counter">
              <span class="actual-length JS-characterCounterAtualLength">0</span>
              /
              <span class="max-length">300</span>
            </div>
            <button type="button" class="close JS-closeQuestionForm" title="Cancelar pergunta">Cancelar pergunta</button>
          </div>
          <textarea class="input JS-formInputQuestion" id="question" name="question" placeholder="Envie uma pergunta" maxlength="300" autocomplete="off" required=""></textarea>
          <div class="actions">
            <button class="button submit">
              <span class="text">Enviar</span>
            </button>
          </div>
        </form>
      {% elif object.youtube_status != 2 and not user.is_authenticated %}
        <div class="unauthenticated">
          <span><a href="/home/?next={{ request.path }}">Faça Login</a> para enviar uma pergunta!</span>
        </div>
      {% elif object.youtube_status == 2 %}
        <div class="closed">
          <span>Audiência encerrada para participações.</span>
        </div>
      {% endif %}
    </aside>

    <main class="room-main">

      <div class="room-video JS-videoFrame">
        <div class="heightwrapper">
          {% include "includes/room_video.html" with object=object %}
          <div class="info">
            <span class="status">
              {% if object.youtube_status == 0 %}
                Transmissão Prevista
              {% elif object.youtube_status == 1 %}
                <span class="live-icon"></span> Ao Vivo
              {% else %}
                Transmissão Encerrada (Gravado)
              {% endif %}
            </span>

            <span class="visitors">
              {% if object.youtube_status == 1 %}
                <span class="numbers" id="online-users">{{object.online_users}}</span> visitantes
              {% else %}
                <span class="numbers">{{object.views}}</span> visualizações
              {% endif %}
            </span>
          </div>
        </div>

        <ul class="extras">
          <li class="extravideo">
            <div class="add">Adicionar Vídeo</div>
          </li>
          <li class="extravideo JS-selectVideo -current">
            <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
            <span class="title">Parte 1</span>
            <button class="aud-button -remove"></button>
          </li>
          <li class="extravideo JS-selectVideo">
            <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
            <span class="title">Parte 2</span>
            <button class="aud-button -remove"></button>
          </li>
          <li class="extravideo JS-selectVideo">
            <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
            <span class="title">Comentários do Deputado Chico Anysio</span>
            <button class="aud-button -remove"></button>
          </li>
          <li class="extravideo JS-selectVideo">
            <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
            <span class="title">Comentários do Deputado Chico Anysio</span>
            <button class="aud-button -remove"></button>
          </li>
        </ul>
      </div>



      <div class="room-info JS-readMoreLess">
        <h3>Pauta</h3>
        {{object.reunion_object|cut:"  "|linebreaks}}
        <button class="more JS-toggleDiv">Ver mais</button>
      </div>

      <div class="room-info JS-readMoreLess">
        <h3>Organização</h3>
        <p>{{object.legislative_body_initials}} - {{object.legislative_body}}</p>
        <button class="more JS-toggleDiv">Ver mais</button>
      </div>

      <div class="room-info JS-readMoreLess">
        <h3>Conteúdo complementar</h3>
        <ul class="list">
          {% for attachment in object.attachments.all %}
          <li>
            <a href="{{ attachment.url }}" target="_blank">{{ attachment.title }}</a>
            <a href="{% url 'delete_attachment' attachment.id %}" class="aud-button -remove"></a>
          </li>
          {% endfor %}
        </ul>
        <button class="more JS-toggleDiv">Ver mais</button>
      </div>

      <button class="aud-button -add JS-openModal" data-modal-target="addContent">Adicionar Conteúdo Complementar</button>
    </main>

    <aside class="room-chat JS-wrapperChat">
      <h2 class="room-h2">Bate-papo</h2>

      <button class="aud-button -mail JS-openModal" data-modal-target="sendEmail">Enviar email para os participantes</button>

      <div class="messageswrapper">
        <div class="messages JS-messages">

          <ul class="list JS-messagesList" id="chat">
            {% if object.messages.all %}
              {% for message in object.messages.all %}
                {% include "includes/chat_message.html" with message=message %}
              {% endfor %}
            {% elif object.youtube_status != 2 %}
              <div class="list -empty JS-messagesListEmpty">
                <img src="{% static 'img/chat-bubble.svg' %}" data-fallback="{% static 'img/chat-bubble.png' %}">
                <p>Nenhuma mensagem foi enviada ainda. Seja o primeiro!</p>
              </div>
            {% endif %}
          </ul>

        </div>

        <button class="read-more JS-readMoreChat">Há novas mensagens disponíveis abaixo</button>
      </div>
      <div class="controls">
        {% if object.youtube_status != 2 and user.is_authenticated %}
          <form class="form JS-formChat" id="chatform">
            <textarea class="input JS-formInputChat" id="message" name="message" placeholder="Envie uma mensagem" autocomplete="off" required></textarea>
            <div class="actions">
              <button class="button" id="go">Enviar</button>
            </div>
          </form>
        {% elif object.youtube_status != 2 and not user.is_authenticated %}
          <div class="unauthenticated">
            <span><a href="/home/?next={{ request.path }}">Faça Login</a> para participar no chat!</span>
          </div>
        {% elif object.youtube_status == 2 %}
          <div class="closed">
            <span>Audiência encerrada para participações.</span>
          </div>
        {% endif %}

        <p class="info">O bate-papo se encerrará em <span class="time">14:58</span>.</p>
        <p class="info">Continue esta conversa <a href="#" class="link">aqui</a>.</p>
      </div>
    </aside>

    {% include 'modals/notification_participants.html' with modal_id='sendEmail' title='Envie um email para os participantes' %}

    {% include 'modals/add_content.html' with modal_id='addContent' title='Adicione links complementares' %}
  </div>

{% endblock %}

{% block footer %}
{% endblock footer %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'mixitup/build/jquery.mixitup.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/components/read-more-less.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/components/share-buttons.js' %}"></script>
  {% compress js %}
    <script type="text/es6" src="{% static 'js/components/tabs-nav.js' %}"></script>
  {% endcompress %}
{% endblock extra_js %}

{% block websockets %}
  {% if object.youtube_status != 2 or user|belongs_to_group:object.legislative_body_initials %}
    <script>
      var HANDLER = "{{handler|default:''}}";
      var HANDLER_GROUPS = [
        {% for group in groups %}
          "{{group}}",
        {% endfor %}
      ]
      var HANDLER_ADMIN = {{user.profile.is_admin|lower|default:'false'}};

      function loginRedirect() {
        var next = "{{request.path}}";
        var login_url = "/home";
        document.location.href = login_url + '?next=' + next;
      }

      var roomApiUrl = "{% url 'room_detail_api' pk=object.id %}";
    </script>
    {% compress js %}
      <script type="text/es6" src="{% static 'js/pages/room.js' %}"></script>
    {% endcompress %}
  {% endif %}
{% endblock %}
