{% extends "components/base.html" %}
{% load staticfiles compress video_utils %}

{% block metadata %}
  <meta property="og:title" content="{{object.legislative_body_alias}}" />
  <meta property="og:site_name" content="Audiências Interativas" />
  <meta property="og:description" content="{{ object.reunion_object }}" />
  <meta property="og:image" content="{{request.scheme}}://{{domain}}{% static 'img/share-image.jpg' %}" />
  <meta property="og:image:type" content="image/jpg" />
  <meta property="og:image:width" content="600" />
  <meta property="og:image:height" content="300" />
  <meta property="og:type" content="website" />
{% endblock metadata %}

{% block navigation %}
{% endblock navigation %}

{% block main %}
  <nav class="tabs-nav">
    <ul class="tabs-nav__list">
      <li class="list__item">
        <a class="item__link" data-tab-index="0">Vídeo</a>
      </li>
      <li class="list__item">
        <a class="item__link" data-tab-index="1">Bate-Papo</a>
      </li>
      <li class="list__item">
        <a class="item__link" data-tab-index="2">Perguntas</a>
      </li>
      <div class="list__item-marker" data-tab-index="0"></div>
    </ul>
  </nav>

  <header class="room-header">

    <a class="logo" href="{% url 'home' %}">
      <img src="{% static 'img/logo-audiencias-h.svg' %}">
    </a>

    <div class="room-title">
      <h1 class="title">
        {% if object.reunion_theme %}
          {{object.reunion_theme}}
        {% else %}
          {% if object.is_joint %}
            {{object.title_reunion}}
          {% else %}
            {{object.legislative_body_alias}}
          {% endif %}
        {% endif %}
      </h1>
      <div class="info">
        <span class="social-share">
          <a class="button -facebook JS-share-lnk" data-social="facebook" title="Facebook"></a>
          <a class="button -twitter JS-share-lnk" data-social="twitter" title="Twitter"></a>
          <a class="button -whatsapp JS-share-lnk" data-social="whatsapp" title="Whatsapp"></a>
        </span>
        <span><a class="link" href="/relatorio">Ver relatório</a></span>
        <span>{{object.reunion_type}}</span>
        <span>{{object.date}}</span>
      </div>
    </div>
  </header>

  <div class="room-container">

    <aside class="room-questions">
      <h2 class="room-h2">Perguntas</h2>
      <p class="-small">Faça sua pergunta ou apoie outra já feita. As perguntas mais votadas serão encaminhadas à Mesa para serem respondidas.</p>
      <div class="questions JS-wrapperQuestion">
        <ul class="questions__list JS-questionsList" id="questions">
          {% if questions %}
            {% for question in questions %}
              {% include "includes/question_card.html" with page="room" %}
            {% endfor %}
          {% elif object.youtube_status != 2 %}
            <div class="questions__list--empty JS-questionlistEmpty">
              <img src="{% static 'img/question-hand.svg' %}" data-fallback="{% static 'img/question-hand.png' %}">
              <p>Nenhuma pergunta foi feita ainda. Seja o primeiro!</p>
            </div>
          {% endif %}
        </ul>
      </div>
      <div class="questions__read-more JS-readMoreQuestion"></div>
      {% if object.youtube_status != 2 and user.is_authenticated %}
        <form class="send-form--questions JS-formQuestion" id="questionform">
          <textarea class="send-form__input JS-formInputQuestion" id="question" name="question" placeholder="Envie uma pergunta" maxlength="300" autocomplete="off" required=""></textarea>
          <div class="send-form__actions">
            <div class="actions__character-counter JS-character-counter">
              <span class="character-counter__actual-length JS-characterCounterAtualLength">0</span>
              /
              <span class="character-counter__max-length">300</span>
            </div>
            <button class="actions__button">
              <span class="button__text">Enviar</span>
              <i class="button__icon icon icon-caret-right"></i>
            </button>
          </div>
        </form>
      {% elif object.youtube_status != 2 and not user.is_authenticated %}
        <div class="send-form--unauthenticated">
          <span><a href="/home/?next={{ request.path }}">Faça Login</a> para enviar uma pergunta!</span>
        </div>
      {% elif object.youtube_status == 2 %}
        <div class="send-form--closed">
          <span>Audiência encerrada para participações.</span>
        </div>
      {% endif %}
    </aside>

    <main class="room-main">

      <div class="room-video JS-videoFrame">  
        {% include "includes/room_video.html" with object=object %}
        <div class="video__status">
          <div class="status__transmission">
            <span class="status__transmission-text">
              {% if object.youtube_status == 0 %}
                Transmissão Prevista
              {% elif object.youtube_status == 1 %}
                <i class="status__live-icon icon icon-circle live-blink"></i>Ao Vivo
              {% else %}
                Transmissão Encerrada (Gravado)
              {% endif %}
            </span>
          </div>
          <div class="status__counter">
            {% if object.youtube_status == 1 %}
              <span class="status__counter-number" id="online-users">{{object.online_users}}</span> <span class="status__counter-text">assistindo</span>
            {% else %}
              <span class="status__counter-number">{{object.views}}</span> <span class="status__counter-text"> visualizações</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="room-info JS-readMoreLess">
        <h3>Pauta</h3>
        {{object.reunion_object|cut:"  "|linebreaks}}
        <button class="more JS-toggleDiv">Ler mais</button>
      </div>

      <div class="room-info JS-readMoreLess">
        <h3>Organização</h3>
        <p>{{object.legislative_body_initials}} - {{object.legislative_body}}</p>
        <button class="more JS-toggleDiv">Ler mais</button>
      </div>

      <div class="room-info JS-readMoreLess">
        <h3>Conteúdo complementar</h3>
        <ul class="list">
          <li>
            <a href="" target="_blank">Matéria da SECOM sobre transporte público</a>
          </li>
          <li>
            <a href="" target="_blank">Vídeo da campanha de transporte público do estado de São Paulo</a>
          </li> 
        </ul>
        <button class="more JS-toggleDiv">Ler mais</button>
      </div>
      
      <button class="aud-button -add">Adicionar Conteúdo Complementar</button>

      <hr>

      <button class="aud-button -mail">Enviar email para os participantes</button>

    </main>

    <aside class="room-chat">
      <h2 class="room-h2">Bate-papo</h2>
      <div class="chat JS-wrapperChat">
        <div class="chat__messages JS-messages">
          <ul class="messages__list JS-messagesList" id="chat">
            {% if object.messages.all %}
              {% for message in object.messages.all %}
                {% include "includes/chat_message.html" with message=message %}
              {% endfor %}
            {% elif object.youtube_status != 2 %}
              <div class="messages__list--empty JS-messagesListEmpty">
                <img src="{% static 'img/chat-bubble.svg' %}" data-fallback="{% static 'img/chat-bubble.png' %}">
                <p>Nenhuma mensagem foi enviada ainda. Seja o primeiro!</p>
              </div>
            {% endif %}
          </ul>
        </div>
        <div class="chat__read-more JS-readMoreChat">Há novas mensagens disponíveis abaixo</div>
        {% if object.youtube_status != 2 and user.is_authenticated %}
          <form class="send-form--chat JS-formChat" id="chatform">
            <textarea class="send-form__input JS-formInputChat" id="message" name="message" placeholder="Envie uma mensagem" autocomplete="off" required></textarea>
            <div class="send-form__actions">
              <button class="actions__button" id="go">
                <i class="button__icon icon icon-paper-plane"></i>
              </button>
            </div>
          </form>
        {% elif object.youtube_status != 2 and not user.is_authenticated %}
          <div class="send-form--unauthenticated">
            <span><a href="/home/?next={{ request.path }}">Faça Login</a> para participar no chat!</span>
          </div>
        {% elif object.youtube_status == 2 %}
          <div class="send-form--closed">
            <span>Audiência encerrada para participações.</span>
          </div>
        {% endif %}
      </div>
    </aside>
    
  </div>

<!--   <div class="aud-modal">
    
    <div class="modal">
      <h1>Olá mundo!</h1>
    </div>

  </div> -->


{% endblock %}

{% block footer %}
{% endblock footer %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'mixitup/build/jquery.mixitup.min.js' %}"></script>
  <script type="text/javascript">
    // This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    // This function creates an <iframe> (and YouTube player)
    // after the API code downloads.
    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
          height: '',
          width: '',
          videoId: '{{object.youtube_id}}',
          events: {
            'onReady': onPlayerReady
          }
      });
    }
    // The API will call this function when the video player is ready.
    function onPlayerReady(event) {
       event.target.playVideo();
    }
  </script>
  <script type="text/javascript" src="{% static 'js/components/read-more-less.js' %}"></script>
  {% compress js %}
    <script type="text/es6" src="{% static 'js/components/tabs-nav.js' %}"></script>
  {% endcompress %}
{% endblock extra_js %}

{% block websockets %}
  {% if object.youtube_status != 2 or user|belongs_to_group:object.legislative_body_initials %}
    <script>
      var HANDLER = "{{handler|default:''}}";
      var HANDLER_GROUPS = [
        {% for group in groups %}
          "{{group}}",
        {% endfor %}
      ]
      var HANDLER_ADMIN = {{user.profile.is_admin|lower|default:'false'}};

      function loginRedirect() {
        var next = "{{request.path}}";
        var login_url = "/home";
        document.location.href = login_url + '?next=' + next;
      }

      var roomApiUrl = "{% url 'room_detail_api' pk=object.id %}";
    </script>
    {% compress js %}
      <script type="text/es6" src="{% static 'js/pages/room.js' %}"></script>
    {% endcompress %}
  {% endif %}
{% endblock %}
