{% extends "components/base.html" %}
{% load staticfiles compress video_utils %}

{% block metadata %}
  <title>{% block title %}Audiências Interativas{% endblock title%}</title>
  <meta name="description" content="{{ object.reunion_object }}">
  <meta property="og:title" content="{{object.legislative_body_alias}}">
  <meta property="og:site_name" content="Audiências Interativas">
  <meta property="og:description" content="{{ object.reunion_object }}">
  <meta property="og:image" content="{{request.scheme}}://{{domain}}{% static 'img/facebook-share-image.jpg' %}">
  <meta property="og:image:type" content="image/jpg">
  <meta property="og:image:width" content="600">
  <meta property="og:image:height" content="300">
  <meta property="og:type" content="website">
  <meta property="og:type" content="website">
  <meta property="twitter:image" content="{{request.scheme}}://{{domain}}{% static 'img/facebook-share-image.jpg' %}">


{% endblock metadata %}

{% block navigation %}
{% endblock navigation %}

{% block main %}

  <header class="room-header JS-room-wrapper" data-room-id="{{object.id}}">

    <a class="logo" href="{% url 'home' %}">
      <img src="{% static 'img/logo-audiencias-h.svg' %}">
    </a>

    <div class="room-title">
      <h1 class="title">
        {% if object.reunion_theme %}
          {{object.reunion_theme}}
        {% else %}
          {% if object.is_joint %}
            {{object.title_reunion}}
          {% else %}
            {{object.legislative_body_alias}}
          {% endif %}
        {% endif %}
      </h1>
      <div class="info">
        <span>{{object.reunion_type}}</span>
        <span>{{object.date}}</span>
      </div>
    </div>

    <span class="social-share">
      <span>Compartilhar</span>
      <a class="button -facebook JS-shareRoom" data-social="facebook" title="Facebook" href="http://www.facebook.com/sharer/sharer.php?u={{request.build_absolute_uri}}" target="_blank" rel="noopener"></a>
      <a class="button -twitter JS-shareRoom" data-social="twitter" title="Twitter" href="http://twitter.com/share?text=Eu já estou participando, participe você também!&url={{request.build_absolute_uri}}" target="_blank" rel="noopener"></a>
      <a class="button -whatsapp JS-shareRoom" data-social="whatsapp" title="Whatsapp" href="whatsapp://send?text=Eu já estou participando, participe você também!&{{request.build_absolute_uri}}" target="_blank" rel="noopener"></a>
    </span>
  </header>

  <nav class="room-tabs">
    <a class="JS-setTab" data-tab-index="0">Vídeo</a>
    <a class="JS-setTab" data-tab-index="1">Bate-Papo</a>
    <a class="JS-setTab" data-tab-index="2">Perguntas</a>
    <div class="marker JS-marker" data-tab-index="0"></div>
  </nav>

  <div class="room-container JS-room" data-tab-index="0">

    <aside class="room-questions JS-wrapperQuestion">
      <h2 class="room-h2">Perguntas</h2>
      <p>Faça sua pergunta ou apoie outra já feita. As perguntas mais votadas serão encaminhadas à Mesa para serem respondidas.</p>
      <a class="link" href="{{request.path}}/perguntas">Ir para a página de perguntas</a>
        <div class="questions-section ">
          <ul class="questions__list JS-questionsList" id="questions">
            {% if questions %}
              {% for question in questions %}
                {% include "includes/question_card.html" with page="room" %}
              {% endfor %}
            {% elif object.youtube_status != 2 %}
              <div class="questions__list--empty JS-questionlistEmpty">
                <img src="{% static 'img/question-hand.svg' %}" data-fallback="{% static 'img/question-hand.png' %}">
                <p>Nenhuma pergunta foi feita ainda. Seja o primeiro!</p>
              </div>
            {% endif %}
          </ul>
          <button class="read-more JS-readMoreQuestion"></button>
        </div>
        {% if object.youtube_status != 2 and user.is_authenticated %}
          <div class="question-action">
            <button class="JS-openQuestionForm">Fazer uma pergunta</button>
          </div>
          <form class="question-box JS-formQuestion" id="questionform">
            <div class="header">
              <div class="counter JS-character-counter">
                <span class="actual-length JS-characterCounterAtualLength">0</span>
                /
                <span class="max-length">300</span>
              </div>
              <button type="button" class="close JS-closeQuestionForm" title="Cancelar pergunta">Cancelar pergunta</button>
            </div>
            <textarea class="input JS-formInputQuestion" id="question" name="question" placeholder="Digite aqui sua pergunta" maxlength="300" autocomplete="off" required=""></textarea>
            <div class="actions">
              <button class="button submit">
                <span class="text">Enviar pergunta</span>
              </button>
            </div>
          </form>
        {% elif object.youtube_status != 2 and not user.is_authenticated %}
          <div class="question-action">
            <span><a href="/home/?next={{ request.path }}">Faça Login</a> para enviar uma pergunta!</span>
          </div>
        {% elif object.youtube_status == 2 %}
          <div class="closed">
            <span>Audiência encerrada para participações.</span>
          </div>
        {% endif %}
    </aside>

    <main class="room-main">

      <div class="room-video">
        <div class="room-title">
          <h1 class="title">
            {% if object.reunion_theme %}
              {{object.reunion_theme}}
            {% else %}
              {% if object.is_joint %}
                {{object.title_reunion}}
              {% else %}
                {{object.legislative_body_alias}}
              {% endif %}
            {% endif %}
          </h1>
          <div class="info">
            <span>{{object.reunion_type}}</span>
            <span>{{object.date}}</span>
          </div>
        </div>
        <div class="heightwrapper">
          <div class="ratiowrapper JS-videoFrame">
            {% include "includes/room_video.html" with object=object %}
            <div class="info">
              <span class="status">
                {% if object.youtube_status == 0 %}
                  Transmissão Prevista
                {% elif object.youtube_status == 1 %}
                  <span class="live-icon"></span> Ao Vivo
                {% else %}
                  Transmissão Encerrada (Gravado)
                {% endif %}
              </span>

              <span class="visitors">
                {% if object.youtube_status == 1 %}
                  <span class="numbers" id="online-users">{{object.online_users}}</span> visitantes
                {% else %}
                  <span class="numbers">{{object.views}}</span> pessoas na sala
                {% endif %}
              </span>
            </div>
          </div>
        </div>

        <ul class="extras">
          <li class="extravideo JS-selectVideo -current">
            <div class="wrapper">
              <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
              <span class="label">Transmissão</span>
            </div>
            <span class="title">Parte 1</span>
          </li>
          <li class="extravideo JS-selectVideo">
            <div class="wrapper">
              <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
              <span class="label">Transmissão</span>
            </div>
            <span class="title">Parte 2</span>
          </li>
          <li class="extravideo JS-selectVideo">
            <div class="wrapper">
              <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
              <button class="aud-button -icon -remove -active JS-openModal" data-modal-target="addVideoDialog" data-dialog-action="acaovideo1"></button>
              <button class="aud-button -icon -edit -active JS-openModal" data-modal-target="editVideo"></button>
              <button class="aud-button -icon -left"></button>
              <button class="aud-button -icon -right"></button>
            </div>
            <span class="title">Comentários do Deputado Chico Anysio</span>
          </li>
          <li class="extravideo JS-selectVideo">
            <div class="wrapper">
              <img class="thumbnail" src="{% static 'img/default-thumbnail.svg' %}">
              <button class="aud-button -icon -remove -active JS-openModal" data-modal-target="addVideoDialog" data-dialog-action="acaovideo1"></button>
              <button class="aud-button -icon -edit -active JS-openModal" data-modal-target="editVideo"></button>
              <button class="aud-button -icon -left"></button>
              <button class="aud-button -icon -right"></button>
            </div>
            <span class="title">Comentários do Deputado Chico Anysio</span>
          </li>
        </ul>
        <button class="aud-button -video JS-openModal" data-modal-target="addVideo">Adicionar vídeo complementar</button>
        <button class="aud-button -order JS-toggleAudButton JS-orderVideos" data-untoggled-text="Reordenar vídeos" data-untoggled-icon="-order" data-toggled-text="Finalizar reordenação" data-toggled-icon="-complete">Reordenar vídeos</button>
      </div>



      <div class="room-info JS-readMoreLess">
        <h3>Pauta</h3>
        {{object.reunion_object|cut:"  "|linebreaks}}
        <button class="more JS-toggleDiv">Ver mais</button>
      </div>

      <div class="room-info JS-readMoreLess">
        <h3>Organização</h3>
        <p>{{object.legislative_body_initials}} - {{object.legislative_body}}</p>
        <button class="more JS-toggleDiv">Ver mais</button>
      </div>

      <div class="room-info JS-readMoreLess">
        <h3>Conteúdo complementar</h3>
        <ul class="list">
          {% for attachment in object.attachments.all %}
          <li>
            <a class="link" href="{{ attachment.url }}" target="_blank">{{ attachment.title }}</a>
            <a class="aud-button -icon -remove JS-openModal" data-modal-target="addContentDialog" data-dialog-action="{% url 'delete_attachment' attachment.id %}"></a>
          </li>
          {% endfor %}
        </ul>
        <button class="more JS-toggleDiv">Ver mais</button>
      </div>

      <button class="aud-button -add JS-openModal" data-modal-target="addContent">Adicionar conteúdo complementar</button>

      <hr>

      <button class="aud-button -mail JS-openModal" data-modal-target="sendEmail">Enviar email para os participantes</button>

      <div class="room-info">
        <ul class="list">
          <li>
            <a class="link" href="{{request.path}}/relatorio">Ir para a página de relatório</a>
          </li>
        </ul>
      </div>

    </main>

    <aside class="room-chat JS-wrapperChat">
      <h2 class="room-h2">Bate-papo</h2>

      <div class="messages">

        <ul class="list JS-messagesList" id="chat">
          {% if object.messages.all %}
            {% for message in object.messages.all %}
              {% include "includes/chat_message.html" with message=message %}
            {% endfor %}
          {% elif object.youtube_status != 2 %}
            <div class="list -empty JS-messagesListEmpty">
              <img src="{% static 'img/chat-bubble.svg' %}" data-fallback="{% static 'img/chat-bubble.png' %}">
              <p>Nenhuma mensagem foi enviada ainda. Seja o primeiro!</p>
            </div>
          {% endif %}
        </ul>
        <button class="read-more JS-readMoreChat">Há novas mensagens disponíveis abaixo</button>

      </div>

      <div class="controls">
        {% if object.youtube_status != 2 and user.is_authenticated %}
          <form class="form JS-formChat" id="chatform">
            <textarea class="input JS-formInputChat" id="message" name="message" placeholder="Digite mensagens do bate-papo aqui" autocomplete="off" required></textarea>
            <div class="actions">
              <button class="button" id="go" title="Enviar">Enviar</button>
            </div>
          </form>
        {% elif object.youtube_status != 2 and not user.is_authenticated %}
          <p class="info"><a class="link" href="/home/?next={{ request.path }}">Faça Login</a> para participar no chat!</p>
        {% elif object.youtube_status == 2 %}
          <div class="closed">
            <span>Audiência encerrada para participações.</span>
          </div>
        {% endif %}

        <p class="info">O bate-papo se encerrará em <span class="time JS-countdownTimer"><span class="JS-countdownMinutes">00</span>:<span class="JS-countdownSeconds">00</span></span>.</p>

        <button class="aud-button -discussion JS-openModal" data-modal-target="addDiscussionLink">Adicionar link para continuar a discussão</button>

        <div class="wrapper">
          <p class="info">Continue esta conversa <a href="#" class="link">aqui</a>.</p>
          <button class="aud-button -icon -edit JS-openModal" data-modal-target="editDiscussionLink"></button>
          <button class="aud-button -icon -remove JS-openModal" data-modal-target="addDiscussionLinkDialog" data-dialog-action="{% url 'remove_external_link' object.id %}"></button>
        </div>
      </div>
    </aside>

    {% include 'modals/notification_participants.html' with modal_id='sendEmail' title='Envie um email para os participantes' %}

    {% include 'modals/add_content.html' with modal_id='addContent' title='Adicione links complementares' %}

    {% include 'modals/add_discussion_link.html' with modal_id='addDiscussionLink' title='Adicione um link para continuar a discussão fora do Audiências Interativas' %}

    {% include 'modals/add_discussion_link.html' with modal_id='editDiscussionLink' title='Altere o link que dá continuidade à discussão fora do Audiências Interativas' %}

    {% include 'modals/add_discussion_link_dialog.html' with modal_id='addDiscussionLinkDialog' %}

    {% include 'modals/add_content_dialog.html' with modal_id='addContentDialog' %}

    {% include 'modals/add_video.html' with modal_id='addVideo' title='Adicione um vídeo complementar do Youtube' %}
    {% include 'modals/add_video.html' with modal_id='editVideo' title='Altere este vídeo complementar do Youtube' %}

    {% include 'modals/add_video_dialog.html' with modal_id='addVideoDialog' %}
  </div>

{% endblock %}

{% block footer %}
{% endblock footer %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'mixitup/build/jquery.mixitup.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/components/read-more-less.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/components/share-buttons.js' %}"></script>
{% endblock extra_js %}

{% block websockets %}
  {% if object.youtube_status != 2 or user|belongs_to_group:object.legislative_body_initials %}
    <script>
      var HANDLER = "{{handler|default:''}}";
      var HANDLER_GROUPS = [
        {% for group in groups %}
          "{{group}}",
        {% endfor %}
      ]
      var HANDLER_ADMIN = {{user.profile.is_admin|lower|default:'false'}};

      function loginRedirect() {
        var next = "{{request.path}}";
        var login_url = "/home";
        document.location.href = login_url + '?next=' + next;
      }

      var roomApiUrl = "{% url 'room_detail_api' pk=object.id %}";
    </script>
    {% compress js %}
      <script type="text/es6" src="{% static 'js/pages/room.js' %}"></script>
    {% endcompress %}
  {% endif %}
{% endblock %}
